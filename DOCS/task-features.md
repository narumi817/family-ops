# タスク機能の設計ドキュメント

## 概要

家族で共有する家事・育児タスクの実行ログを管理し、ポイントを集計する機能。

## 機能一覧

### 1. タスクログの登録
- 家族に紐づく家事を1つ選択
- 実行時間を選択（デフォルトは現在時刻）
- ログインしている本人に紐づく
- Logデータとして保存

### 2. タスクログの表示
- デフォルトは当日0時〜24時間分の家族のログをタイムライン表示
- 自分の実行したタスクの当日の累計ポイントを表示
- （将来）人で絞り込み、家事で絞り込み、日時指定で絞り込み
- 実行した人によって色分け

### 3. 家族に紐づくタスクの登録
- タスク登録時に追加できるUI
- ポイントを指定

### 4. タスクのポイント変更
- 設定画面など別画面で管理
- 頻繁に変更しないため、メイン画面とは別

### 5. （将来）ゴール設定とポイント消費
- ゴールが設定できる
- 累計ポイント、使用できるポイントを別管理

---

## 必要な画面

### 1. ログ一覧画面（ホーム/ダッシュボード）
**パス**: `/` (既存の `index.vue` を拡張)

**機能**:
- 当日0時〜24時間分の家族のログをタイムライン表示
- 自分の実行したタスクの当日の累計ポイントを表示
- 各ログに実行者の色分け表示
- 「ログを追加」ボタンでタスクログ登録画面を開く

**表示項目**:
- 実行時刻
- タスク名
- 実行者名（色分け）
- ポイント
- メモ
- （将来）フィルタリングUI（人、家事、日時）

**状態管理**:
- ログ一覧データ
- 当日の累計ポイント
- フィルタリング条件（将来）

---

### 2. タスクログ登録画面
**パス**: `/logs/new` または モーダル

**機能**:
- 家族に紐づくタスクを選択（ドロップダウン or カード選択）
- 実行時間を選択（デフォルト: 現在時刻）
- 「新しいタスクを追加」リンクでタスク追加UIを表示（将来）
- 登録ボタンでログを作成

**フォーム項目**:
- タスク選択（必須）
- 実行日時（オプション、デフォルト: 現在時刻）
- メモ（オプション）

**バリデーション**:
- タスク選択: 必須
- 実行日時: 日時形式

---

### 3. タスクマスタ管理画面（設定画面）
**パス**: `/families/[id]/tasks` または `/settings/tasks`

**機能**:
- 家族に紐づくタスク一覧を表示
- タスクのポイントを変更
- タスクの追加・編集・削除（将来）

**表示項目**:
- タスク名
- カテゴリ（育児/家事）
- ポイント（家族固有のポイント or デフォルトポイント）
- 説明
- 編集ボタン

**操作**:
- ポイント編集（モーダル or インライン編集）
- （将来）タスク追加・編集・削除

---

### 4. タスク追加UI（ログ登録時）
**パス**: `/logs/new` 内のモーダル or インラインUI

**機能**:
- タスクログ登録画面から「新しいタスクを追加」をクリック
- タスク名、カテゴリ、ポイントを入力
- 家族固有のタスクとして登録

**フォーム項目**:
- タスク名（必須）
- カテゴリ（必須: 育児/家事）
- ポイント（必須）

**バリデーション**:
- タスク名: 必須、重複チェック（家族内）
- カテゴリ: 必須
- ポイント: 必須、0以上

---

## 必要なAPI

### 既存API

#### 1. ログ作成
- **エンドポイント**: `POST /api/v1/logs`
- **機能**: タスクログを登録
- **パラメータ**:
  - `log[task_id]` (必須): タスクID
  - `log[performed_at]` (オプション): 実行日時（空の場合は現在時刻）
  - `log[notes]` (オプション): メモ
- **レスポンス**: 作成されたログ情報

#### 2. 家族のログ一覧取得
- **エンドポイント**: `GET /api/v1/family/logs`
- **機能**: 家族のログ一覧を取得
- **パラメータ**:
  - `date` (オプション): 日付（YYYY-MM-DD形式）
  - `start_date` (オプション): 開始日
  - `end_date` (オプション): 終了日
  - `page` (オプション): ページ番号
- **レスポンス**: ログ一覧（ページネーション付き）

---

### 新規追加が必要なAPI

#### 3. 家族のタスク一覧取得
- **エンドポイント**: `GET /api/v1/families/:id/tasks`
- **機能**: 家族に紐づくタスク一覧を取得（全家族共通 + 家族固有）
- **パラメータ**:
  - `category` (オプション): カテゴリで絞り込み（childcare/housework）
- **レスポンス**:
  ```json
  {
    "tasks": [
      {
        "id": 1,
        "name": "おむつ替え",
        "category": "childcare",
        "points": 10,
        "family_points": 10,  // 家族固有のポイント（なければデフォルトポイント）
        "is_custom": false     // 家族固有かどうか
      }
    ]
  }
  ```

#### 4. 家族固有のタスク作成
- **エンドポイント**: `POST /api/v1/families/:id/tasks`
- **機能**: 家族固有のタスクを作成
- **パラメータ**:
  - `task[name]` (必須): タスク名
  - `task[category]` (必須): カテゴリ（childcare/housework）
  - `task[points]` (必須): ポイント
- **レスポンス**: 作成されたタスク情報

#### 5. タスクのポイント変更
- **エンドポイント**: `PUT /api/v1/families/:id/tasks/:task_id/points` または
- **エンドポイント**: `PATCH /api/v1/families/:id/tasks/:task_id/points`
- **機能**: 家族固有のタスクポイントを設定・更新
- **パラメータ**:
  - `points` (必須): ポイント数
- **レスポンス**: 更新されたポイント情報

#### 6. 当日の累計ポイント取得
- **エンドポイント**: `GET /api/v1/family/points/today`
- **機能**: ログイン中のユーザーの当日の累計ポイントを取得
- **パラメータ**: なし
- **レスポンス**:
  ```json
  {
    "user_id": 1,
    "user_name": "はなこ",
    "today_points": 150,
    "date": "2024-01-25"
  }
  ```

#### 7. （将来）フィルタリング付きログ一覧
- **エンドポイント**: `GET /api/v1/family/logs` (既存を拡張)
- **追加パラメータ**:
  - `user_id` (オプション): ユーザーIDで絞り込み
  - `task_id` (オプション): タスクIDで絞り込み

---

## データ構造

### Log（既存）
- `user_id`: 実行者
- `task_id`: タスク
- `performed_at`: 実行日時
- `notes`: メモ

### Task（既存）
- `name`: タスク名
- `category`: カテゴリ（childcare/housework）
- `points`: デフォルトポイント
- `family_id`: 家族ID（nullの場合は全家族共通）

### FamilyTaskPoint（既存）
- `family_id`: 家族ID
- `task_id`: タスクID
- `points`: 家族固有のポイント

---

## 実装順序（推奨）

### Phase 1: 基本機能
1. **ログ一覧画面の拡張** (`/`)
   - 当日のログをタイムライン表示
   - 当日の累計ポイント表示
   - 実行者の色分け

2. **タスクログ登録画面** (`/logs/new`)
   - タスク選択
   - 実行時間選択
   - ログ作成API呼び出し

3. **家族のタスク一覧取得API** (`GET /api/v1/families/:id/tasks`)
   - 全家族共通 + 家族固有のタスクを返す
   - 家族固有のポイントも含める

### Phase 2: タスク管理
4. **タスクマスタ管理画面** (`/families/[id]/tasks`)
   - タスク一覧表示
   - ポイント変更UI

5. **タスクポイント変更API** (`PUT /api/v1/families/:id/tasks/:task_id/points`)
   - FamilyTaskPointの作成・更新

6. **当日の累計ポイント取得API** (`GET /api/v1/family/points/today`)
   - ログから当日のポイントを集計

### Phase 3: 拡張機能（将来）
7. **タスク追加UI**（ログ登録時）
8. **フィルタリング機能**（人、家事、日時）
9. **ゴール設定とポイント消費機能**

---

## 画面遷移図

```
/ (ログ一覧)
  ├─ [ログを追加] → /logs/new
  └─ [設定] → /families/[id]/tasks

/logs/new (タスクログ登録)
  ├─ [登録] → / (ログ一覧に戻る)
  └─ [新しいタスクを追加] → モーダル or インラインUI

/families/[id]/tasks (タスクマスタ管理)
  └─ [ポイント編集] → モーダル or インライン編集
```

---

## 技術的な考慮事項

### ポイント計算
- タスクのポイントは `Task.points_for_family(family_id)` を使用
- FamilyTaskPointに設定があればそれを優先、なければTaskのデフォルトポイント

### 日時フィルタリング
- デフォルトは当日0時〜24時間分
- `Log.for_family_with_filters` を使用

### 実行者の色分け
- フロント側でユーザーIDに基づいて色を割り当て
- カラーパレットを固定（例: 4人まで対応）

### パフォーマンス
- ログ一覧はページネーション対応（20件/ページ）
- タスク一覧はキャッシュ可能（頻繁に変更されない）

