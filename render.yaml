services:
  # Rails API (backend)
  - type: web
    name: family-ops-api
    env: ruby
    rootDir: api
    plan: free
    buildCommand: |
      bundle install --without development test
    startCommand: |
      bundle exec rails db:migrate && bundle exec rails db:seed && bundle exec rails server -p $PORT -b 0.0.0.0
    autoDeploy: true
    healthCheckPath: /up
    envVars:
      # Rails 環境
      - key: RAILS_ENV
        value: production
      - key: RACK_ENV
        value: production
      # DB 接続URLは Render の Postgres にリンクして自動注入
      - key: DATABASE_URL
        fromDatabase:
          name: family-ops-db
          property: connectionString
      # メール送信設定（Resend）
      # Render のダッシュボードで以下の環境変数を手動で設定してください:
      # RESEND_API_KEY      : Resend の API キー
      # RESEND_FROM_EMAIL   : 送信元メールアドレス (例: "FamilyOps <no-reply@your-domain>")
      # MAILER_HOST         : メール本文内リンクのホスト (例: family-ops-client.onrender.com)

  # Nuxt 3 (frontend)
  - type: web
    name: family-ops-client
    env: node
    rootDir: client
    plan: free
    buildCommand: |
      npm ci
      npm run build
    startCommand: |
      node .output/server/index.mjs
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      # Nuxt から見た API URL を Render のサービスURLから取得
      # 例: value: https://api.your-domain.com
      - key: BASE_URL
        value: https://family-ops-api.onrender.com

databases:
  - name: family-ops-db
    plan: free
    databaseName: family_ops
    user: family_ops


