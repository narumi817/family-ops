# サインアップ・招待画面設計書

## 概要

FamilyOpsのサインアップと招待機能に必要な画面の一覧とフローを定義します。

## 実装済みAPI一覧

### 通常サインアップフロー

1. **POST /api/v1/signup/email**
   - メールアドレスを登録し、確認メールを送信
   - パラメータ: `email`
   - レスポンス: `{ message: "確認メールを送信しました" }`

2. **GET /api/v1/signup/verify?token=xxx**
   - メールアドレス確認トークンを検証
   - レスポンス: `{ email: "...", verified: true }`

3. **POST /api/v1/signup/complete**
   - ユーザー・家族を作成
   - パラメータ: `email`, `name`, `password`, `password_confirmation`, `family_name`, `role` (optional)
   - レスポンス: `{ user: {...}, family: {...} }`

### 招待フロー

1. **POST /api/v1/families/:id/invitations**
   - 家族メンバーへの招待メールを送信（ログイン必須）
   - パラメータ: `email`
   - レスポンス: `{ message: "招待メールを送信しました", invitation: {...} }`

2. **GET /api/v1/invitations/verify?token=xxx**
   - 招待トークンを検証
   - レスポンス: `{ email: "...", family: {...}, inviter: {...}, invited: true }`

3. **POST /api/v1/invitations/complete**
   - 招待経由でユーザーを作成し、家族に紐付け
   - パラメータ: `token`, `name`, `password`, `password_confirmation`
   - レスポンス: `{ user: {...}, family: {...} }`

## 必要な画面一覧

### 1. 通常サインアップフロー

#### 1-1. メールアドレス入力画面
- **パス**: `/signup/email`
- **説明**: 新規ユーザーがメールアドレスを入力する画面
- **入力項目**:
  - メールアドレス（必須）
- **画面側バリデーション**:
  - 必須チェック
  - メールアドレス形式チェック（簡易的、正規表現）
- **アクション**:
  - 「確認メールを送信」ボタン → `POST /api/v1/signup/email`
  - 成功時 → `/signup/email_sent` へ遷移
  - エラー時 → エラーメッセージを表示（`error` または `errors.email`）

#### 1-2. 確認メール送信完了画面
- **パス**: `/signup/email_sent`
- **説明**: 確認メール送信完了を通知する画面
- **表示内容**:
  - 「確認メールを送信しました」メッセージ
  - メールボックスを確認するよう案内
  - メールが届かない場合の案内
- **アクション**:
  - 「メールを再送信」ボタン（オプション）

#### 1-3. メール認証画面
- **パス**: `/signup/verify?token=xxx`
- **説明**: メール内のリンクから遷移し、トークンを自動検証する画面
- **処理**:
  - ページ読み込み時に `GET /api/v1/signup/verify?token=xxx` を自動実行
  - 成功時 → emailをセッションストレージに一時保存し、`/signup/complete` へリダイレクト（URLには表示しない）
  - 失敗時 → エラーメッセージを表示（「このリンクは無効か、有効期限が切れています」）
- **表示内容**:
  - ローディング中: 「認証中...」
  - 成功時: 自動リダイレクト（セッションストレージにemailを保存）
  - 失敗時: エラーメッセージと「メールアドレス入力画面に戻る」リンク

#### 1-4. ユーザー情報登録画面
- **パス**: `/signup/complete`
- **説明**: ユーザー名、パスワード、家族名を入力して登録を完了する画面
- **入力項目**:
  - メールアドレス（表示のみ、セッションストレージから取得）
  - ユーザー名（必須）
  - パスワード（必須、6文字以上）
  - パスワード（確認用）（必須）
  - 家族名（必須）
  - 家族内での役割（オプション、デフォルト: "other"）
    - 選択肢: その他 / 母親 / 父親 / 子
- **画面側バリデーション**:
  - 必須チェック（name, password, password_confirmation, family_name）
  - パスワード一致チェック（password === password_confirmation）
- **アクション**:
  - 「登録を完了する」ボタン → `POST /api/v1/signup/complete`
  - 成功時 → ダッシュボード（`/`）へ遷移
  - エラー時 → フィールドごとのエラーメッセージを表示（`errors` 形式）

### 2. 招待フロー

#### 2-1. 招待認証画面
- **パス**: `/invitations/verify?token=xxx`
- **説明**: 招待メール内のリンクから遷移し、トークンを自動検証する画面
- **処理**:
  - ページ読み込み時に `GET /api/v1/invitations/verify?token=xxx` を自動実行
  - 成功時 → `/invitations/complete?token=xxx` へ遷移
  - 失敗時 → エラーメッセージを表示
- **表示内容**:
  - ローディング中: 「認証中...」
  - 成功時: 自動リダイレクト
  - 失敗時: エラーメッセージ（「このリンクは無効か、有効期限が切れています」）

#### 2-2. 招待受諾画面
- **パス**: `/invitations/complete?token=xxx`
- **説明**: 招待を受諾してユーザー登録を完了する画面
- **表示内容**:
  - 招待情報（家族名、招待者名）を表示
  - メールアドレス（表示のみ、APIレスポンスから取得）
- **入力項目**:
  - ユーザー名（必須）
  - パスワード（必須、6文字以上）
  - パスワード（確認用）（必須）
- **画面側バリデーション**:
  - 必須チェック（name, password, password_confirmation）
  - パスワード一致チェック（password === password_confirmation）
- **アクション**:
  - 「招待を受諾する」ボタン → `POST /api/v1/invitations/complete`
  - 成功時 → ダッシュボード（`/`）へ遷移
  - エラー時 → フィールドごとのエラーメッセージを表示（`errors` 形式）

### 3. 既存ユーザーが家族メンバーを招待（将来実装）

#### 3-1. 家族メンバー招待画面
- **パス**: `/families/:id/invitations/new`（将来実装）
- **説明**: 既存ユーザーが家族メンバーを招待する画面
- **前提**: ログイン必須
- **入力項目**:
  - 招待先メールアドレス（必須）
- **画面側バリデーション**:
  - 必須チェック
  - メールアドレス形式チェック（簡易的、正規表現）
- **アクション**:
  - 「招待メールを送信」ボタン → `POST /api/v1/families/:id/invitations`
  - 成功時 → 成功メッセージを表示
  - エラー時 → エラーメッセージを表示（`error` または `errors.email`）

## 画面遷移フロー

### 通常サインアップフロー

```
/signup/email
  ↓ (確認メール送信)
/signup/email_sent
  ↓ (メール内リンククリック)
/signup/verify?token=xxx
  ↓ (自動認証成功、セッションストレージにemail保存)
/signup/complete
  ↓ (登録完了、セッションストレージからemail削除)
/ (ダッシュボード)
```

### 招待フロー

```
(招待メール内リンク)
  ↓
/invitations/verify?token=xxx
  ↓ (自動認証成功)
/invitations/complete?token=xxx
  ↓ (登録完了)
/ (ダッシュボード)
```

## デザイン方針

- **Tailwind CSS**を使用
- **清潔感のあるデザイン**を心がける
- モバイルファースト（既存のログイン画面と統一感を保つ）
- エラーメッセージは各入力フィールドの下に表示
- ローディング状態を適切に表示

## バリデーション方針

- **画面側バリデーション**: API側でもバリデーションチェックしている項目は、画面側でも簡易的にバリデーションチェックを実装する
- 必須チェック、形式チェック（メールアドレス、パスワード一致など）を画面側でも実装
- エラーメッセージはAPI側のレスポンスを優先し、画面側バリデーションは補助的に使用

## 共通レイアウト

### 認証前レイアウト（`layouts/auth.vue`）
- ログイン画面、サインアップ画面で使用
- フルスクリーン、中央配置
- ヘッダー・フッターなし

### 認証後レイアウト（`layouts/default.vue`）
- 認証済みユーザー向けの画面で使用
- ナビゲーション（サイドバーまたはヘッダー）を含む
- ナビゲーション項目:
  - 家族一覧（`/families` - 将来実装）
  - ログ投稿（`/logs/new` - 将来実装）
  - ダッシュボード（`/`）
  - ログアウト

## 実装順序

1. 共通レイアウトの整理
   - `layouts/auth.vue` - 認証前レイアウト
   - `layouts/default.vue` - 認証後レイアウト（ナビゲーション付き）

2. 通常サインアップフロー
   - `/signup/email` - メールアドレス入力
   - `/signup/email_sent` - 送信完了
   - `/signup/verify` - メール認証
   - `/signup/complete` - ユーザー情報登録

3. 既存ユーザーが家族メンバーを招待
   - `/families/:id/invitations/new` - 招待送信

4. 招待フロー
   - `/invitations/verify` - 招待認証
   - `/invitations/complete` - 招待受諾

## URL命名規則

- 単語を繋げる場合は**アンダースコア（`_`）**を使用
- 例: `/signup/email_sent`, `/families/:id/invitations/new`

